name: Build & Deploy to Docker & Kubernetes ðŸš€

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment name (e.g. dev, prod)'
        required: true
        default: 'dev'

env:
  SERVICES_JAVA: "core-shared-lib service-registry gateway-service reference-data-service auth-service appointment-service access-management-service data-analysis-service"
  SERVICES_DOCKER: "service-registry gateway-service reference-data-service auth-service appointment-service access-management-service data-analysis-service"
  WEB_PORTAL: "web-portal"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build all Java projects (Maven)
        run: |
          for dir in $SERVICES_JAVA; do
            if [ -d "$dir" ] && [ -f "$dir/pom.xml" ]; then
              echo "ðŸ”¨ Building $dir ..."
              (cd "$dir" && mvn -q clean package -DskipTests)
            else
              echo "âš ï¸ Skipping $dir (no pom.xml)"
            fi
          done

      - name: Set up Node.js for Web Portal
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build Web Portal (React/Vite)
        run: |
          if [ -d "$WEB_PORTAL" ]; then
            echo "ðŸ§± Building $WEB_PORTAL ..."
            cd "$WEB_PORTAL"
            npm ci
            npm run build
            cd ..
          else
            echo "âš ï¸ Web portal directory not found, skipping..."
          fi

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & Push Docker images (Java services)
        run: |
          for dir in $SERVICES_DOCKER; do
            if [ -f "$dir/Dockerfile" ]; then
              IMAGE="${{ secrets.DOCKER_USERNAME }}/$dir"
              echo "ðŸ³ Building & pushing $IMAGE ..."
              docker build -t "$IMAGE:${{ github.sha }}" "$dir"
              docker tag "$IMAGE:${{ github.sha }}" "$IMAGE:latest"
              docker push "$IMAGE:${{ github.sha }}"
              docker push "$IMAGE:latest"
            else
              echo "âš ï¸ Skipping $dir (no Dockerfile)"
            fi
          done

      - name: Build & Push Web Portal Docker image
        run: |
          if [ -d "$WEB_PORTAL" ] && [ -f "$WEB_PORTAL/Dockerfile" ]; then
            IMAGE="${{ secrets.DOCKER_USERNAME }}/$WEB_PORTAL"
            echo "ðŸŒ Building & pushing $IMAGE ..."
            docker build -t "$IMAGE:${{ github.sha }}" "$WEB_PORTAL"
            docker tag "$IMAGE:${{ github.sha }}" "$IMAGE:latest"
            docker push "$IMAGE:${{ github.sha }}"
            docker push "$IMAGE:latest"
          else
            echo "âš ï¸ Skipping web portal (no Dockerfile found)"
          fi

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Create kubeconfig file
        run: echo "${{ secrets.KUBECONFIG_CONTENT }}" > kubeconfig.yaml

      - name: Deploy to Kubernetes
        run: |
          kubectl --kubeconfig=kubeconfig.yaml apply -f K8S/
          kubectl --kubeconfig=kubeconfig.yaml get pods -A
